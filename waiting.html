<html>

<head>
    <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0 user-scalable=0" />
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>加入矮人礦坑遊戲</title>
    <link rel="shortcut icon" href="svg/icon.svg" type="image/x-icon" />
    <meta name="Saboteur" content="矮人礦坑">
    <meta property="og:title" content="矮人礦坑" />
    <meta property="og:image" content="svg/icon.svg" />
    <meta property="og:description" content="矮人礦坑！" />
    <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&amp;display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/5223ebc999.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous">
    </script>


</head>
<link rel="stylesheet" href="waiting.css">

<body>
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-primary btn-share" data-bs-toggle="modal" data-bs-target="#exampleModal">
        <span></span><i class="fas fa-link" id="sharelink"></i> 複製邀請連結
    </button>
    <!-- Modal -->
    <div class="modal fade" id="sharelinkModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                <img src="svg/welcome.svg" alt="" class="welcome">
                <div class="modal-header">
                    <h4 class="modal-title" id="exampleModalLabel">邀請你的朋友進來房間</h4>
                </div>
                <input type="text" id="url">
                <h5 class="linkcue">請將下方連結分享給他們</h5>
                <input type="button" class="copybtn" value="複製連結" onClick="url.select();document.execCommand('Copy')">
            </div>
        </div>
    </div>


    <div class="container">
        <p class="topinfo">等待其他玩家加入</p>

        <img src="svg/watinghi.svg" class="hi">
        <hr style="color: #FFFCEF; margin: 0px;">
        <svg class="dot" version="1.1" id="L5" xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 30 60 40"
            enable-background="new 0 0 0 0" xml:space="preserve">
            <circle fill="#C54C4D" stroke="none" cx="6" cy="50" r="6">
                <animateTransform attributeName="transform" dur="1s" type="translate" values="0 15 ; 0 -15; 0 15"
                    repeatCount="indefinite" begin="0.1"></animateTransform>
            </circle>
            <circle fill="#C54C4D" stroke="none" cx="30" cy="50" r="6">
                <animateTransform attributeName="transform" dur="1s" type="translate" values="0 10 ; 0 -10; 0 10"
                    repeatCount="indefinite" begin="0.2"></animateTransform>
            </circle>
            <circle fill="#C54C4D" stroke="none" cx="54" cy="50" r="6">
                <animateTransform attributeName="transform" dur="1s" type="translate" values="0 5 ; 0 -5; 0 5"
                    repeatCount="indefinite" begin="0.3"></animateTransform>
            </circle>
        </svg>
        <hr style="color: #FFFCEF; margin: 5px;">

        <div class="playerarea">
        </div>
        <!-- <hr> -->
        <!-- <img class="iconrotate" src="svg/icon rotate.svg" alt=""> -->

    </div>

    </div>
    <!-- Button trigger modal -->
    <button type="button" id="show-role-btn" class="btn btn-primary" data-bs-toggle="modal">
        房主功能：直接開始遊戲
    </button>
    <p class="info"><i class="fas fa-exclamation-triangle"></i>點擊後所有人一起開始進入遊戲，確認所有成員都加入後再點擊此按鈕</p>

    <!-- Modal SHOW ROLE -->
    <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
        aria-labelledby="staticBackdropLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rolebox">
                <div class="modal-header">
                    <h5 class="modal-title" id="staticBackdropLabel">你的角色是：</h5>
                </div>
                <div class="modal-body">
                    <div class="flip-box">

                        <div class="flip-box-inner">
                            <div class="flip-box-front">點選查看您的角色
                                <!-- <h2>點選查看您的角色</h2> -->
                            </div>
                            <div class="flip-box-back">
                                <img class="role" src="svg/role_good_font.svg">
                            </div>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" id="start-game" class="btn btn-secondary">OK</button>
                </div>
            </div>
        </div>
    </div>


</body>
<script src="./script/api.js"></script>
<script src="./script/common.js"></script>
<script src="https://cdn.socket.io/4.1.2/socket.io.min.js"
    integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous">
</script>
<script src="./script/socket.js"></script>
<script src="./script/listener/room.js"></script>
<script>
    // // //卡片翻轉效果
    // $('.flip-box-inner').on('click', function () {
    //     $('.flip-box-inner').css("transform","rotateY(180deg)");
    // });



    var CURRENT_ROOM_ID = getUrlParameter('room_id');
    var INVITE_URL = `${window.location.origin}/invite.html?room_id=${CURRENT_ROOM_ID}`;
    var START_GAME_URL = `${window.location.origin}/index.html`;

    const renderPlayer = (players) => {
        let displayUsers = '';
        players.forEach((player) => {
            displayUsers += `
                <div class="user" style="
                    background-image: url(svg/user.svg);
                    background-size: cover;
                ">${player}</div>            
            `;
        });
        $('.playerarea').html(displayUsers);
    }

    $('#show-role-btn').click(() => {
        sendEvent('showRole', {
            roomId: CURRENT_ROOM_ID,
            show: true,
        });

        showRole();
    })

    function showRole() {
        $('#staticBackdrop').modal('show');
        $('#start-game').hide();
        //卡片翻轉效果
        $('.flip-box-inner').on('click', function () {
            $('.flip-box-inner').css("transform", "rotateY(180deg)");
            $('#start-game').show();
        });
        
    }

    $(document).ready(function () {
        if (!window.localStorage.getItem('nickname')) {
            window.location.href = INVITE_URL;
        }
        if (!CURRENT_ROOM_ID) {
            window.location.href = START_GAME_URL;
        }

        sendEvent('join', {
            roomId: CURRENT_ROOM_ID,
            nickname: getNickName()
        })

        callApi(`/rooms/${CURRENT_ROOM_ID}`).then((response) => {
            const data = response.data;
            const players = Object.keys(data.players);
            renderPlayer(players);
            const owner = data.owner;

            if (owner !== getNickName()) {
                hideNotOwnerSetting();
            }
        });

        $("#url").val(INVITE_URL);
        if (!getUrlParameter('invite')) {
            $('#sharelinkModal').modal('show');
        }

    });

    const hideNotOwnerSetting = () => {
        $('#start-game').hide();
        $('#show-role-btn').hide();
        $('.info').hide();
    }

    $(".btn-primary").click(function () {
        $('#sharelinkModal').modal('show');
    })
    //一鍵複製連結
    function copyUrl() {
        var url = document.getElementById("url").value;
        window.clipboardData.setData("Text", url);

    }

    const copybtn = document.querySelector(".copybtn")
    copybtn.addEventListener("click", function (e) {
        e.preventDefault();
        document.querySelector(".linkcue").textContent = "已成功複製連結！";
        $(".linkcue").css({
            "color": "#bb392c",
            "font-size": "10px"
        });
        //禁止開啟手機鍵盤
        document.activeElement.blur();
    })

    $('#start-game').click(function () {
        sendEvent('startGame', {
            roomId: CURRENT_ROOM_ID,
        })
        window.location.href = `./playpage.html?room_id=${CURRENT_ROOM_ID}`;
    })
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous">
</script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"
    integrity="sha384-IQsoLXl5PILFhosVNubq5LC7Qb9DXgDA9i+tQ8Zj3iwWAwPtgFTxbJ8NT4GN1R8p" crossorigin="anonymous">
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.min.js"
    integrity="sha384-lpyLfhYuitXl2zRZ5Bn2fqnhNAKOAaM/0Kr9laMspuaMiZfGmfwRNFh8HlMy49eQ" crossorigin="anonymous">
</script>

</html>