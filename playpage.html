<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1 user-scalable=0" />
  <title>矮人礦坑</title>
  <link rel="shortcut icon" href="svg/icon.svg" type="image/x-icon" />
  <meta name="Saboteur" content="矮人礦坑">
  <!-- 常用於 facebook 的 屬性值 -->
  <meta property="og:title" content="矮人礦坑" />
  <meta property="og:type" content="PlayingPage" />
  <meta property="og:url" content="網址" />
  <meta property="og:image" content="svg/welcome.svg" />
  <meta property="og:description" content="最有質感的線上版矮人礦坑遊戲，一起來玩吧！" />
  <!-- 字體 -->
  <link href="https://fonts.googleapis.com/css2?family=Kosugi+Maru&amp;display=swap" rel="stylesheet">
</head>
<link rel="stylesheet" href="playpage.css" />

<body>

  <!-- user顯示在最上方 -->
  <div class="flexbox playerarea" id="user-block"></div>

  <div class="container">
    <!-- 聊天區1 顯示於大螢幕裝置 -->
    <div class="chatarea chatarea1">
      <!-- 角色顯示區與步驟提示區 -->
      <div class="flexbox stepinfo">
        <div class="rolebox">
          <div class="userRole"></div>
          <div id="team-wording" class="rolecue"></div>
        </div>

        <ul class="stepinfoTxt">
        </ul>
      </div>

      <hr>
      <ul id="messageBody" class="scrollbox">
      </ul>
      <div class="chatinputbox">
        <div class="chatUser" value="阿婷"></div>
        <input id="inputChat" class="inputChat" type="text" placeholder="來聊天ㄅ" autocomplete="off">
        <div id="chatbtn" class="chatbtn" style="display: none;"></div>
      </div>
    </div>
    <div class="chaticon"><i class="far fa-comment"></i></div>
    <!-- 棋盤格子區 -->
    <div class="flexbox showarea">
      <div class="line line1">
        <div id="block1-1" class="block block1-1"></div>
        <div id="block1-2" class="block block1-2"></div>
        <div id="block1-3" class="block block1-3">
          <!-- <img src="svg/card_start.svg" alt="" /> -->
          <img id="start" data-num="block1-3" src="svg/card_start.svg" top="true" left="true" right="true"
            bottom="true" />
        </div>
        <div id="block1-4" class="block block1-4"></div>
        <div id="block1-5" class="block block1-5"></div>
      </div>
      <div class="line line2">
        <div id="block2-1" class="block block2-1"></div>
        <div id="block2-2" class="block block2-2"></div>
        <div id="block2-3" class="block block2-3"></div>
        <div id="block2-4" class="block block2-4"></div>
        <div id="block2-5" class="block block2-5"></div>
      </div>
      <div class="line line3">
        <div id="block3-1" class="block block3-1"></div>
        <div id="block3-2" class="block block3-2"></div>
        <div id="block3-3" class="block block3-3"></div>
        <div id="block3-4" class="block block3-4"></div>
        <div id="block3-5" class="block block3-5"></div>
      </div>
      <div class="line line4">
        <div id="block4-1" class="block block4-1"></div>
        <div id="block4-2" class="block block4-2"></div>
        <div id="block4-3" class="block block4-3"></div>
        <div id="block4-4" class="block block4-4"></div>
        <div id="block4-5" class="block block4-5"></div>
      </div>
      <div class="line line5">
        <div id="block5-1" class="block block5-1"></div>
        <div id="block5-2" class="block block5-2"></div>
        <div id="block5-3" class="block block5-3"></div>
        <div id="block5-4" class="block block5-4"></div>
        <div id="block5-5" class="block block5-5"></div>
      </div>
      <div class="line line6">
        <div id="block6-1" class="block block6-1"></div>
        <div id="block6-2" class="block block6-2"></div>
        <div id="block6-3" class="block block6-3"></div>
        <div id="block6-4" class="block block6-4"></div>
        <div id="block6-5" class="block block6-5"></div>
      </div>
      <div class="line line7">
        <div id="block7-1" class="block block7-1"></div>
        <div id="block7-2" class="block block7-2"></div>
        <div id="block7-3" class="block block7-3"></div>
        <div id="block7-4" class="block block7-4"></div>
        <div id="block7-5" class="block block7-5"></div>
      </div>
      <div class="line line8">
        <div id="block8-1" class="block block8-1"></div>
        <div id="block8-2" class="block block8-2"></div>
        <div id="block8-3" class="block block8-3"></div>
        <div id="block8-4" class="block block8-4"></div>
        <div id="block8-5" class="block block8-5"></div>
      </div>
      <div class="line line9">
        <div id="block9-1" class="block block9-1 end1">
          <img data-num="1" src="svg/cards_blank.svg" class="end" id="end1" />
        </div>
        <div id="block9-2" class="block block9-2"></div>
        <div id="block9-3" class="block block9-3 end2">
          <img data-num="2" src="svg/cards_blank.svg" class="end" id="end2" />
        </div>
        <div id="block9-4" class="block block9-4"></div>
        <div id="block9-5" class="block block9-5 end3">
          <img data-num="3" src="svg/cards_blank.svg" class="end" id="end3" />
        </div>
      </div>
      <!-- 提示區 -->
      <div class="flexbox topcue cue-message">
      </div>
      <div class="flexbox topcue">
        <div class="p">請放置卡牌開闢新的路，或使用功能卡，或</div>
        <span class="trash"><i class="fas fa-trash fa-lg">棄牌並跳過</i></span>
      </div>
    </div>


    <!-- 手牌區 -->
    <div class="flexbox handcardarea">
      <div class="handcardbox handcardbox1" data-num="1">
        <img id="handCard1" class="card cardnum1" data-num="1" src="svg/cards_blank.svg" />
        <i data-num="1" class="fas fa-undo-alt cycle-1"></i>
      </div>

      <div class="handcardbox handcardbox2" data-num="2">
        <img id="handCard2" class="card cardnum2" data-num="2" src="svg/cards_blank.svg" />
        <i data-num="2" class="fas fa-undo-alt cycle-2"></i>
      </div>

      <div class="handcardbox handcardbox3" data-num="3">
        <img id="handCard3" class="card cardnum3" data-num="3" src="svg/cards_blank.svg" />
        <i data-num="3" class="fas fa-undo-alt cycle-3"></i>
      </div>

      <div class="handcardbox handcardbox4" data-num="4">
        <img id="handCard4" class="card cardnum4" data-num="4" src="svg/cards_blank.svg" />
        <i data-num="4" class="fas fa-undo-alt cycle-4"></i>
      </div>

      <div class="handcardbox handcardbox5" data-num="5">
        <img id="handCard5" class="card cardnum5" data-num="5" src="svg/cards_blank.svg" />
        <i data-num="5" class="fas fa-undo-alt cycle-5"></i>
      </div>

      <div class="handcardbox handcardbox6" data-num="6">
        <img id="handCard6" class="card cardnum6" data-num="6" src="svg/cards_blank.svg" />
        <i data-num="6" class="fas fa-undo-alt cycle-6"></i>
      </div>
    </div>

    <!-- 聊天區2 顯示於小螢幕裝置 -->
    <div class="chatarea chatarea2">
      <!-- 角色顯示區與步驟提示區 -->
      <div class="flexbox stepinfo">
        <div class="rolebox">
          <div class="userRole"></div>
          <div id="team-wording" class="rolecue"></div>
        </div>

        <ul class="stepinfoTxt">
        </ul>
      </div>
      <ul id="messageBody" class="scrollbox">
      </ul>
      <div class="chatinputbox">
        <div class="chatUser" value="阿婷"></div>
        <input id="inputChat" class="inputChat" type="text" placeholder="來聊天ㄅ" autocomplete="off">
        <!-- <div id="chatbtn" class="chatbtn"></div>
        <div class="chatclose"><i class="fas fa-times"></i></div> -->
      </div>
    </div>
    <div class="chaticon"><i class="far fa-comment"></i></div>

  </div>
  <!-- //這是container的div勿刪*///再以下就是container外 -->

  <div class="yourturnCue" style="display: none;">
    <p class="yourturntxt">輪到你了！</p>
    <img src="https://img.itch.zone/aW1nLzIzNTkyMDEucG5n/original/HXrjt2.png" class="yourturnpic">
    <p class="yourturnalert"> </p>
    <div class="ok" id="get-ready">OK</div>
  </div>

  <link rel="preload" as="image" href="svg/card_end1.svg">
  <link rel="preload" as="image" href="svg/card_end2.svg">
  <link rel="preload" as="image" href="svg/card_end3.svg">

  <!-- Button trigger modal -->
  <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
    遊戲回合勝負結果
  </button> -->

  <!-- Modal -->
  <!-- <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <img src="svg/status/goodwin.svg" alt="" class="winpic">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">好矮人獲勝！</h5>
        </div>
        <div class="modal-body">
          獲勝玩家：
          <div class="username name1">阿婷 <span>5分</span></div>
          <div class="username name2">阿文 <span>5分</span></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="homebtn">回首頁</button>
          <button type="button" class="palyagain">再玩一局</button>
          <button type="button" class="rankbtn">看總排行</button>

        </div>
      </div>
    </div>
  </div> -->

</body>
<script src="https://kit.fontawesome.com/5223ebc999.js" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"
  integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

<script src="./script/api.js"></script>
<script src="./script/common.js"></script>
<script src="https://cdn.socket.io/4.1.2/socket.io.min.js"
  integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous">
  </script>
<script src="./script/socket.js"></script>
<script src="./script/listener/room.js"></script>
<script src="script/card_map.js"></script>

<script>
  var MAP_CARDS = new RegExp('41|42|43|44|45|46', "g");
  var LAMP_SAVE_CARDS = new RegExp('47|48', "g");
  var AX_SAVE_CARDS = new RegExp('49|50', "g");
  var CAR_SAVE_CARDS = new RegExp('51|52', "g");

  var LAMP_CAR_SAVE_CARDS = new RegExp('53', "g");
  var LAMP_AX_SAVE_CARDS = new RegExp('54', "g");
  var AX_CAR_SAVE_CARDS = new RegExp('55', "g");

  var LAMP_BAN_CARDS = new RegExp('56|57|58', "g");
  var AX_BAN_CARDS = new RegExp('59|60|61', "g");
  var CAR_BAN_CARDS = new RegExp('62|63|64', "g");
  var BOMB_CARDS = new RegExp('65|66|67', "g");
  var TOOL_CARDS = [47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67];
  var CURRENT_ROOM_ID = getUrlParameter('room_id');
  var END_BLOCK = ['end1', 'end2', 'end3'];
  var COUNT_INTERVAL_ID = null;
  var BOARD = null;


  const hasRedBorder = () => {
    return $('.redborder').length ? true : false;
  }

  function Cardput(cardData) {
    if ($(".redborder").attr('can-put-to-board') == 0) {
      alert("道具損毀，無法放置道路卡");
      return;
    }
    if (event.target.id.search(/block|end|trash/) == -1 && $('.redborder').attr("src").search(/65|66|67/) == 14) {
      putCardToServer(cardData);
      return;
    }
    //圈選手牌後，可再點擊的位置：block|end|trash，其他處不可放卡牌，如：起始牌、已放卡牌的位置
    if (event.target.id.search(/block|end|trash/) == -1) {
      alert("此處不能放置卡牌");
      return;
    }
    //如果圈選的手牌是“地圖卡”，不可放在牌區，只可以丟棄，或去點終點卡
    if ($('.redborder').attr("src").search(/41|42|43|44|45|46/) !== -1) {
      alert("不能把地圖卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“破壞卡”，不可放在牌區
    if ($('.redborder').attr("src").search(/56|57|58|59|60|61|62|63|64/) == 14) {
      alert("不能把破壞卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“修理卡”，不可放在牌區
    if ($('.redborder').attr("src").search(/47|48|49|50|51|52|53|54|55/) !== -1) {
      alert("不能把修理卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“崩路卡”，不可放在牌區，只可以丟棄，或去點已放的卡牌炸掉
    if ($('.redborder').attr("src").search(/65|66|67/) !== -1) {
      alert("不能把崩路卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“道路卡”，且可以放在牌區，並且會印出出牌的卡，並在補上手牌
    if (event.target.id.search("block") == 0) {
      CheckPosition(event.target.id, cardData);

      return;
    }
    putCardToServer(cardData);

  }

  function printNewCard() {
    const element = document.getElementById(event.target.id);
    const boxnum = $(".redborder").attr("data-num")
    const svg = $(".handcardbox" + boxnum + " img").attr('src');
    const top = $(".handcardbox" + boxnum + " img").attr('top');
    const right = $(".handcardbox" + boxnum + " img").attr('right');
    const left = $(".handcardbox" + boxnum + " img").attr('left');
    const bottom = $(".handcardbox" + boxnum + " img").attr('bottom');
    const center = $(".handcardbox" + boxnum + " img").attr('center');
    const style = $(".handcardbox" + boxnum + " img").css('transform');
    element.innerHTML +=
      `<img data-num="${event.target.id}" src='${svg}' top="${top}" left="${left}" right="${right}" bottom="${bottom}" center="${center}" style='transform:${style}'>`;
  }

  function giveNewCard(handCards) {
    const boxnum = $(".redborder").attr("data-num")
    const index = boxnum - 1
    $(".redborder").removeClass("redborder");
    degrees = 0
    $(".cardnum" + boxnum).attr("style", "transform: rotate(0deg);")
    giveDirection(index, handCards[parseInt(index)]);

  }

  function renderCards(userInfo) {
    const handCards = userInfo['cards'];
    const isBan = userInfo['is_ban'];

    for (let index = 0; index < 6; index++) {
      const cardNumber = handCards[index];
      giveDirection(index, cardNumber, isBan);
    }
  }

  $(document).ready(function () {
    callApi(`/rooms/${CURRENT_ROOM_ID}`).then((response) => {
      const data = response.data;
      const players = data.turn;

      renderPlayer(players, data);

      const userInfo = data.players[getNickName()];

      const team = userInfo.team == '1' ? '好' : '壞';
      $('#team-wording').text(`你是${team}矮人`);

      data.chat_record.forEach((chatRecord) => {
        renderChatRecord(chatRecord);
      })
      renderEventLogs(data.logs);
      const whoCanMove = data.play_can_move;

      changePlayerToMove(data);
      renderCards(userInfo);
      renderBoard(data.board);
    });

    sendEvent('join', {
      roomId: CURRENT_ROOM_ID,
      nickname: getNickName()
    });
  });

  var delay = function (s) {
    return new Promise(function (resolve, reject) {
      setTimeout(resolve, s);
    });
  };

  function renderEventLogs(logs) {
    let displayString = '';
    logs.reverse().forEach((log) => {
      displayString += `
        <li>${log.nickname}${log.message}</li>
      `;
    });

    $('.stepinfoTxt').html(displayString)
  }

  const changePlayerToMove = (roomInfo) => {
    var endCards = roomInfo.end_block_cards;

    if (roomInfo.play_can_move !== getNickName()) {
      $(".yourturnCue").hide();
      $('.card').unbind('click');
      $('.block').unbind('click');
      $('.trash').unbind('click');
    } else {
      const userId = roomInfo.turn.indexOf(getNickName()) + 1;

      $(`#user${userId}`).addClass("yourturnbgc")
      $(".yourturnCue").show();
      COUNT_INTERVAL_ID = wiggle();
      //功能:點擊卡牌產生紅色提醒
      $('.card').bind('click', function (e) {
        if ($(this).attr('class').search("redborder") == -1) {
          $(".redborder").removeClass("redborder");
          $(this).addClass("redborder");
        }
      });
      // 移除卡牌
      $('.trash').bind('click', function (e) {
        $(".cue-message").text("你棄牌並跳過");
        deleteCardToServer($('.redborder').attr('card-id'));
      })
      $('.end').bind('click', (e) => {
        const endcardid = e.target.id;
        const endcardelement = $(`#${endcardid}`)
        if (!hasRedBorder()) {
          rotatecard(endcardelement);
          return;
        }
        if ($('.redborder').attr("src").search(MAP_CARDS) == -1) {
          alert("你這張不是地圖卡，要有地圖卡才能看！");
          return;
        }
        if ($('.redborder').attr("src").search(/41|42|43|44|45|46/) !== -1) {
          const endNum = endcardelement.attr('data-num')
          endcardelement.attr("src", `svg/card_end${endCards[endNum - 1]}.svg`);
          const endDirection = END_DIRECTION[endCards[endNum - 1]];
          ['top', 'left', 'right', 'bottom', 'center'].forEach((direction) => {
            endcardelement.attr(direction, endDirection[direction]);
          });
          $(".cue-message").text("你查看了一張終點卡");

          sendEvent('recordLog', {
            roomId: CURRENT_ROOM_ID,
            nickname: getNickName(),
            message: '查看了一張終點卡',
          });

          const endId = endCards[endNum - 1];

          $(`.end${endNum}`).attr('src', `svg/card_end${endId}.svg`);

          delay(5000).then(() => {
            $(`.end${endNum}`).html(`
                  <img data-num="${endNum}" src="svg/cards_blank.svg" class="end" id="end${endNum}">
              `);

            deleteCardToServer($(".redborder").attr('card-id'));
          });
        }
      })
      //功能:點擊棋盤判斷
      $('.block').bind('click', function (event) {
        if (!hasRedBorder()) {
          return;
        }
        if (END_BLOCK.includes(event.target.id)) {
          return;
        }

        if ($(".redborder").attr('can-put-to-board') == 0) {
          alert("道具損毀，無法放置道路卡");
          return;
        }
        //崩路卡
        if (event.target.id.search('start') !== -1 && $('.redborder').attr("src").search(/65|66|67/) !== -1) {
          alert("不可以崩掉起點卡")
          return;
        }

        let target = event.target.getAttribute("data-num");
        if (event.target.getAttribute("data-num") === null) {
          target = event.target.id;
        }
        const [positionY, positionX] = target.match(/\d/g);
        const cardData = {
          cardId: $(".redborder").attr('card-id'),
          positionX: positionX,
          positionY: positionY,
          top: $(".redborder").attr('top'),
          bottom: $(".redborder").attr('bottom'),
          left: $(".redborder").attr('left'),
          right: $(".redborder").attr('right'),
          center: $(".redborder").attr('center'),
          style: $(".redborder").attr('style'),
        }

        if (event.target.id.search(/block|end|trash/) == -1 && event.target.getAttribute("src").search(/32|33|34|35|36|37|38|39|40/) && $('.redborder').attr("src").search(/65|66|67/) !== -1) {
          const boxnum = $(".redborder").attr("data-num")
          const svg = $(".handcardbox" + boxnum + " img").attr('src');
          const style = $(".handcardbox" + boxnum + " img").css('transform');
          renderDeleteBlockId(event.target.getAttribute("data-num"));

          $(".cue-message").text("你使用崩路卡，移除了一條坑路");
          sendEvent('recordLog', {
            roomId: CURRENT_ROOM_ID,
            nickname: getNickName(),
            message: '使用崩路卡，移除了一條坑路',
          });
          cardData.haveToDeleteCard = true;
          putCardToServer(cardData, event.target.getAttribute("data-num"));

          return;
        }

        if (hasRedBorder() && $('.redborder').attr("src").search(/32|33|34|35|36|37|38|39|40/) !== -1) {
          $(".cue-message").text("你放了一張坑洞卡");
          sendEvent('recordLog', {
            roomId: CURRENT_ROOM_ID,
            nickname: getNickName(),
            message: '放了一張坑洞卡',
          });
          Cardput(cardData);
          return;
        }
        $(".cue-message").text("你放了一張道路卡");
        sendEvent('recordLog', {
          roomId: CURRENT_ROOM_ID,
          nickname: getNickName(),
          message: '放了一張道路卡',
        });
        Cardput(cardData);
        return;
      });
    }
  }

  const renderBoard = (board) => {
    if (typeof board === 'undefined' || board === null) {
      return;
    }
    for (const [positionX, positionData] of Object.entries(board)) {
      for (const [positionY, cardData] of Object.entries(positionData)) {
        if (
          (positionX == 3 && positionY == 1)
          || (positionX == 1 && positionY == 9)
          || (positionX == 3 && positionY == 9)
          || (positionX == 5 && positionY == 9)
        ) {
          continue;
        }
        const block = `block${positionY}-${positionX}`;
        const element = $(`#${block}`);
        const style = cardData.style !== null ? `style='${cardData.style}'` : null;
        element.html(`
          <img 
            data-num="${block}" 
            src='svg/cards/card${cardData.cardId}.svg' 
            top="${cardData.top}" 
            left="${cardData.left}" 
            right="${cardData.right}" 
            bottom="${cardData.bottom}" 
            center="${cardData.center}" 
            ${style}
          >
        `);
      }
    }
  }

  const checkIsGameFinish = (roomInfo) => {
    if (roomInfo.is_end == true) {
      delay(5000).then(() => {
        const winTeam = roomInfo.win_team;
        const winTeamName = winTeam == 1 ? '好矮人' : '壞矮人';
        let winPlayers = [];
        for (const [player, info] of Object.entries(roomInfo.players)) {
          if (info.team == winTeam) {
            winPlayers.push(player);
          }
        }

        alert(`${winTeamName}獲勝! 獲勝玩家為 ${winPlayers.join(',')}`);
      });
    }
  }

  const showEndCards = (roomInfo) => {
    roomInfo.open_end_cards.forEach((cardPosition) => {
      switch (cardPosition) {
        case 0:
          const positionInfo = roomInfo.board['1']['9'];
          break;
        case 1:

      
        default:
          break;
      }
      const positionInfo = roomInfo.board[(2 * cardPosition) + 1]['9'];
      const endCardPosition = $(`#end${cardPosition + 1}`);
      endCardPosition.attr('src', `svg/card_end${roomInfo.end_block_cards[cardPosition]}.svg`)
      endCardPosition.attr('top', positionInfo['top']);
      endCardPosition.attr('bottom', positionInfo['bottom']);
      endCardPosition.attr('right', positionInfo['right']);
      endCardPosition.attr('left', positionInfo['left']);
      endCardPosition.attr('center', positionInfo['center']);
    })
  }

  function renderPlayer(players, roomInfo) {
    showEndCards(roomInfo);
    checkIsGameFinish(roomInfo);
    let displayUsers = '';
    let counter = 1;
    let playersData = roomInfo.players;
    const whoCanMove = roomInfo.play_can_move;
    players.forEach((player) => {
      const playerData = playersData[player];
      const axBanNumber = playerData.tools.ax == 0 ? null : `statusBan${playerData.tools.ax}`;
      const lampBanNumber = playerData.tools.lamp == 0 ? null : `statusBan${playerData.tools.lamp}`;
      const carBanNumber = playerData.tools.car == 0 ? null : `statusBan${playerData.tools.car}`;

      let highlight = whoCanMove == player ? 'yourturnbgc' : null;
      displayUsers += `
        <div class="userbox">
          <div id="user${counter}" class="username ${highlight}" data-num="${counter}">${player}
          </div>
          <div class="flexbox statusbox">
            <div data-num="${counter}" ban-num=${playerData.tools.ax} class="status ax${counter} ${axBanNumber}" style="
                background-image: url(svg/status/status_ax.svg);
                background-size: cover;
              "></div>
            <div data-num="${counter}" ban-num="${playerData.tools.car}" class="status car${counter} ${carBanNumber}" style="
                background-image: url(svg/status/status_car.svg);
                background-size: cover;
              "></div>
            <div data-num="${counter}" ban-num="${playerData.tools.lamp}" class="status lamp${counter} ${lampBanNumber}" style="
                background-image: url(svg/status/status_lamp.svg);
                background-size: cover;
              "></div>
          </div>
        </div>         
      `;

      counter += 1;
    });
    $('#user-block').html(displayUsers);

    //封鎖
    $(".username").bind('click', function (e) {
      if (!hasRedBorder()) {
        return;
      }
      const LAMP_BAN = $('.redborder').attr("src").search(LAMP_BAN_CARDS)
      const AX_BAN = $('.redborder').attr("src").search(AX_BAN_CARDS)
      const CAR_BAN = $('.redborder').attr("src").search(CAR_BAN_CARDS)
      const LAMP_SAVE = $('.redborder').attr("src").search(LAMP_SAVE_CARDS)
      const AX_SAVE = $('.redborder').attr("src").search(AX_SAVE_CARDS)
      const CAR_SAVE = $('.redborder').attr("src").search(CAR_SAVE_CARDS)

      const LAMP_CAR_SAVE = $('.redborder').attr("src").search(LAMP_CAR_SAVE_CARDS)
      const LAMP_AX_SAVE = $('.redborder').attr("src").search(LAMP_AX_SAVE_CARDS)
      const AX_CAR_SAVE = $('.redborder').attr("src").search(AX_CAR_SAVE_CARDS)


      let hasBanTool = false;
      let toolChineseName = '';
      let banTools = [];

      if (LAMP_BAN !== -1) {
        hasBanTool = true;
        banTools.push("lamp")
        toolChineseName = "燈"
      }
      if (AX_BAN !== -1) {
        hasBanTool = true;
        banTools.push("ax")
        toolChineseName = "斧頭";
      }
      if (CAR_BAN !== -1) {
        hasBanTool = true;
        banTools.push("car")
        toolChineseName = "礦車";
      }

      let hasSaveTool = false;
      let savetoolChineseName = '';
      let saveTools = [];
      if (LAMP_SAVE !== -1) {
        hasSaveTool = true;
        saveTools.push("lamp")
        savetoolChineseName = "燈"
      }
      if (AX_SAVE !== -1) {
        hasSaveTool = true;
        saveTools.push("ax")
        savetoolChineseName = "斧頭"
      }
      if (CAR_SAVE !== -1) {
        hasSaveTool = true;
        saveTools.push("car")
        savetoolChineseName = "礦車"
      }
      if (LAMP_CAR_SAVE !== -1) {
        saveTools.push('lamp');
        saveTools.push('car');
        savetoolChineseName = "燈和礦車"
        hasSaveTool = true;
      }
      if (LAMP_AX_SAVE !== -1) {
        saveTools.push('lamp');
        saveTools.push('ax');
        savetoolChineseName = "燈和斧頭"
        hasSaveTool = true;
      }
      if (AX_CAR_SAVE !== -1) {
        saveTools.push('ax');
        saveTools.push('car');
        savetoolChineseName = "斧頭和礦車"
        hasSaveTool = true;
      }

      if (!hasRedBorder()) {
        return;
      }
      if (!hasBanTool && !hasSaveTool) {
        alert("你這張不是破壞卡或修理卡，不能用在這邊！");
        return;
      }

      const usernum = $(`#${e.target.id}`).attr("data-num");

      if (hasBanTool) {
        banTools.forEach((banToolName) => {
          const usernum = $(`#${e.target.id}`).attr("data-num");
          if ($(`.${banToolName}${usernum}`).attr("class").search(/statusBan\d/g) !== -1) {
            let banNum = $(`.${banToolName}${usernum}`).attr('class').match(/statusBan\d/g)[0].match(/\d/g)[
              0];
            $(`.${banToolName}${usernum}`).removeClass(`statusBan${banNum}`);
            banNum = parseInt(banNum) + 1
            $(`.${banToolName}${usernum}`).addClass(`statusstyle`);
            $(`.${banToolName}${usernum}`).addClass(`statusBan${banNum}`);
            $(`.${banToolName}${usernum}`).attr('ban-num', String(banNum));
            $(".cue-message").text(`你破壞了${$(e.target).text()}的${toolChineseName}`);
            sendEvent('recordLog', {
              roomId: CURRENT_ROOM_ID,
              nickname: getNickName(),
              message: `破壞了${$(e.target).text().trim()}的${toolChineseName}`,
            });
          } else {
            $(`.${banToolName}${usernum}`).addClass(`statusBan1`);
            $(`.${banToolName}${usernum}`).attr('ban-num', '1');
            $(".cue-message").text(`你破壞了${$(e.target).text()}的${toolChineseName}`);
            sendEvent('recordLog', {
              roomId: CURRENT_ROOM_ID,
              nickname: getNickName(),
              message: `破壞了${$(e.target).text().trim()}的${toolChineseName}`,
            });
          }
        });
        const toolsData = {
          cardId: $(".redborder").attr('card-id'),
          targetName: $(e.target).text().trim(),
          tools: {
            'ax': parseInt($(`.ax${usernum}`).attr('ban-num')),
            'lamp': parseInt($(`.lamp${usernum}`).attr('ban-num')),
            'car': parseInt($(`.car${usernum}`).attr('ban-num')),
          }
        }
        updateToolsToServer(toolsData);
        return;
      }


      if (hasSaveTool) {
        saveTools.forEach((saveToolName) => {
          if ($(`.${saveToolName}${usernum}`).attr("class").search(/statusBan1/g) !== -1) {
            $(`.${saveToolName}${usernum}`).removeClass(`statusBan1`);
            $(`.${saveToolName}${usernum}`).attr('ban-num', '0');
            $(`.${saveToolName}${usernum}`).removeClass(`statusstyle`);
          }
          if ($(`.${saveToolName}${usernum}`).attr("class").search(/statusBan\d/g) !== -1) {
            const usernum = $(`#${e.target.id}`).attr("data-num");
            let banNum = $(`.${saveToolName}${usernum}`).attr('class').match(/statusBan\d/g)[0].match(
              /\d/g)[0];
            $(`.${saveToolName}${usernum}`).removeClass(`statusBan${banNum}`);
            banNum = parseInt(banNum) - 1
            $(`.${saveToolName}${usernum}`).addClass(`statusBan${banNum}`);
            $(`.${saveToolName}${usernum}`).attr('ban-num', String(banNum));
          }
          $(".cue-message").text(`你修理了${$(e.target).text()}的${savetoolChineseName}`);
          sendEvent('recordLog', {
            roomId: CURRENT_ROOM_ID,
            nickname: getNickName(),
            message: `修理了${$(e.target).text().trim()}的${savetoolChineseName}`,
          });
        });
        const toolsData = {
          cardId: $(".redborder").attr('card-id'),
          targetName: $(e.target).text().trim(),
          tools: {
            'ax': parseInt($(`.ax${usernum}`).attr('ban-num')),
            'lamp': parseInt($(`.lamp${usernum}`).attr('ban-num')),
            'car': parseInt($(`.car${usernum}`).attr('ban-num')),
          }
        }
        updateToolsToServer(toolsData);
      }
    });
  }

  function giveDirection(index, cardNumber, isBan) {
    const handCardNumber = index + 1;
    let handCardElement = $(`#handCard${handCardNumber}`);

    let canPutToBoard = 1;
    if (isBan && cardNumber !== 'undefined' && !TOOL_CARDS.includes(cardNumber)) {
      canPutToBoard = 0;
    }

    if (typeof cardNumber === 'undefined') {
      handCardElement.hide();
      $(`.handcardbox${handCardNumber}`).hide();
      return;
    }
    handCardElement.attr("src", `svg/cards/card${cardNumber}.svg`);
    handCardElement.attr("card-id", cardNumber);
    handCardElement.attr("can-put-to-board", canPutToBoard);
    if (typeof ROAD_DIRECTION_MAP[cardNumber] !== 'undefined') {
      const roadDirection = ROAD_DIRECTION_MAP[cardNumber];
      ['top', 'left', 'right', 'bottom', 'center'].forEach((direction) => {
        handCardElement.attr(direction, roadDirection[direction]);
      })
    }
  }

  function renderDeleteBlockId(deleteBlockId) {
    $(`#${deleteBlockId}`).html(``);
    $(`#${deleteBlockId}`).css("background-color", "#D37E80");
  }

  const updateToolsToServer = (toolsData) => {
    const nickname = getNickName();
    callApi(`/rooms/${CURRENT_ROOM_ID}/players/${nickname}/tools`, 'POST', toolsData).then((response) => {
      if (response.status === '400') {
        alert('操作錯誤');
        return;
      }

      sendEvent('getRoomInfo', {
        roomId: CURRENT_ROOM_ID,
      });

      $('.card').unbind('click');
      $('.block').unbind('click');
      handCards = response.data.players[nickname].cards;
      giveNewCard(handCards);
    });
  }

  const deleteCardToServer = (cardId) => {
    const nickname = getNickName();
    callApi(`/rooms/${CURRENT_ROOM_ID}/players/${nickname}/cards/delete`, 'POST', {
      'id': CURRENT_ROOM_ID,
      'name': nickname,
      'cardId': cardId
    }).then((response) => {
      if (response.status === '400') {
        alert('操作錯誤');
        return;
      }

      sendEvent('getRoomInfo', {
        roomId: CURRENT_ROOM_ID,
      });

      $('.card').unbind('click');
      $('.block').unbind('click');
      $('.trash').unbind('click');
      handCards = response.data.players[nickname].cards;
      renderPlayer(response.data.turn, response.data);
      giveNewCard(handCards);
    });
  }

  const putCardToServer = (cardData, deleteBlockId = null) => {
    const nickname = getNickName();
    callApi(`/rooms/${CURRENT_ROOM_ID}/players/${nickname}/cards`, 'POST', cardData).then((response) => {
      if (response.status === '400') {
        alert('操作錯誤');
        return;
      }
      if (deleteBlockId) {
        sendEvent('getDeleteBlock', {
          roomId: CURRENT_ROOM_ID,
          deleteBlockId: deleteBlockId,
        });
      } else {
        sendEvent('getRoomInfo', {
          roomId: CURRENT_ROOM_ID,
        });
      }

      $('.card').unbind('click');
      $('.block').unbind('click');
      handCards = response.data.players[nickname].cards;
      giveNewCard(handCards);
    });
  }

  // 圖卡旋轉
  var degrees = 0;

  function rotatecard(object) {
    degrees += 180;

    object.css({
      'transform': 'rotate(' + degrees + 'deg)',
      '-ms-transform': 'rotate(' + degrees + 'deg)',
      '-moz-transform': 'rotate(' + degrees + 'deg)',
      '-webkit-transform': 'rotate(' + degrees + 'deg)',
      '-o-transform': 'rotate(' + degrees + 'deg)'
    });

    const topValue = object.attr("top");
    const RightValue = object.attr("right");
    const LeftValue = object.attr("left");
    const BottomValue = object.attr("bottom");
    const CenterValue = object.attr("center");

    object.attr("bottom", topValue);
    object.attr("left", RightValue);
    object.attr("right", LeftValue);
    object.attr("top", BottomValue);
    object.attr("center", CenterValue);
  }
  var degrees = 0;
  $(".fa-undo-alt").on("click", function (e) {
    const number = $(this).attr("data-num")
    rotatecard($(".cardnum" + number));
    return;
  });

  var END_DIRECTION = {
    1: {
      top: true,
      right: true,
      left: true,
      bottom: true,
      center: true,
    },
    2: {
      top: true,
      right: false,
      left: true,
      bottom: false,
      center: true,
    },
    3: {
      top: true,
      right: true,
      left: false,
      bottom: false,
      center: true,
    }
  }

  // 聊天室新增 聊天內容
  const scrollbox = document.querySelector('.scrollbox');
  const inputChat = document.querySelector(".inputChat");
  const chatbtn = document.querySelector(".chatbtn");

  $(".chatbtn").click(function (e) {
    const chatUser = getNickName();
    const inputChatcontent = $('.inputChat').val();
    if (inputChatcontent.trim() === '') {
      return;
    }
    sendEvent('sendMessage', {
      roomId: CURRENT_ROOM_ID,
      nickname: chatUser,
      content: inputChatcontent,
    });
    var messageBody = document.querySelector('#messageBody');
    messageBody.scrollTop = (messageBody.scrollHeight - messageBody.clientHeight);
    $('.inputChat').val('');

  })
  //聊天關閉
  $(document).ready(function () {
    $(".chaticon").hide();
  });

  function renderChatRecord(chatRecord) {
    const chatUser = chatRecord.nickname;
    const content = chatRecord.content;

    $('#messageBody').append(`
      <li>${chatUser}：${content}</li >
    `);
  }

  inputChat.addEventListener("keyup", function (event) {
    if (event.keyCode === 13) {
      event.preventDefault();
      document.getElementById("chatbtn").click();
    }
  });

  $(".ok").on('click', function () {
    $(".yourturnCue").hide();
    clearInterval(COUNT_INTERVAL_ID)
  })

  function wiggle(isStart = false) {
    var wiggletime = 0;

    return setInterval(function () {
      if ($(".yourturnCue").is(':hover') === true) {
        $(".yourturnCue").css({
          "left": "50%",
          "transition-duration": "0.3s"
        });
        return;
      }
      if (wiggletime <= 300) {
        wiggletime += 1;
        if (wiggletime % 2 == 0) {
          $(".yourturnCue").css({
            "left": "51%",
            "transition-duration": "0.3s"
          });
        } else {
          $(".yourturnCue").css({
            "left": "49%",
            "transition-duration": "0.3s"
          });
          if (wiggletime >= 100 && wiggletime <= 300) {
            $(".yourturntxt").text("閒置狀態");
            $(".yourturnalert").text("您還在嗎？按下確認鍵以防斷線");
          }
        }
        if (wiggletime >= 301) {
          $(".yourturnCue").css({
            "left": "50%",
            "transition-duration": "0.3s"
          });
          $(".yourturntxt").text("來不及了");
          $(".yourturnpic").attr("src", "https://image.emojipng.com/840/12628840.jpg")
          $(".yourturnalert").text("你錯過了你的回合");
          $(".ok").hide();
        }
      }
    }, 100);
  }

  //提醒玩家超過2分鐘了
  $(".yourturnCue").click(function () {
    $(".yourturntxt").text("你還需要一些思考時間嗎？");
    $(".yourturnpic").attr("src", "https://icon-library.com/images/thinking-icon/thinking-icon-15.jpg")
    $(".yourturnalert").text("按下確認鍵再繼續1分鐘");
  })
  //提醒玩家他已錯過了自己的回合
  $(".yourturnCue").dblclick(function () {
    $(".yourturntxt").text("來不及了");
    $(".yourturnpic").attr("src", "https://image.emojipng.com/840/12628840.jpg")
    $(".yourturnalert").text("你錯過了你的回合");
    $(".ok").hide();
  })


  //點選連結到別的畫面
  $('.homebtn').click(function () {
    window.location.href = "./index.html";
  });
  $('.palyagain').click(function () {
    window.location.href = "./waiting.html";
  });
  $('.rankbtn').click(function () {
    window.location.href = "./rank.html";
  })
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" //
  integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous">
  </script>

</html>
