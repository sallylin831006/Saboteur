<!DOCTYPE html PUBLIC "-//WAPFORUM//DTD XHTML Mobile 1.0//EN" "http://www.wapforum.org/DTD/xhtml-mobile10.dtd">
<html lang="en">

<head>
  <meta name="viewport"
    content="width=device-width, height=device-height, initial-scale=1.0, maximum-scale=0.25 user-scalable=0" />
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>矮人礦坑</title>
  <!-- <link rel="shortcut icon" href="https://i.ibb.co/vJ42VtN/ia2b-001.png" type="image/x-icon" /> -->
  <meta name="1A2B" content="矮人礦坑" />
  <meta property="og:title" content="矮人礦坑" />
  <!-- <meta property="og:image" content="https://i.ibb.co/3RxtDV9/001.png" /> -->
  <meta property="og:description" content="矮人礦坑！" />
  <script src="https://kit.fontawesome.com/5223ebc999.js" crossorigin="anonymous"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"
    integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
</head>
<link rel="stylesheet" href="playpage.css" />

<body>
  <div class="container">
    <div class="cuetext topcue">
      輪到你出牌了！ 你是壞矮人！ 排堆剩餘提醒:
    </div>
    <div class="flexbox playerarea">


      <div class="userbox">
        <div class="score">5</div>
        <div id="user1" class="username" data-num="1"
          style="background-image: url(svg/user.svg);background-size: cover;">阿婷
        </div>
        <div class="flexbox statusbox">
          <div data-num="1" class="status ax1" style="
                background-image: url(svg/status/status_ax.svg);
                background-size: cover;
              "></div>
          <div data-num="1" class="status car1" style="
                background-image: url(svg/status/status_car.svg);
                background-size: cover;
              "></div>
          <div data-num="1" class="status lamp1" style="
                background-image: url(svg/status/status_lamp.svg);
                background-size: cover;
              "></div>
        </div>
      </div>

      <div class="userbox">
        <div class="score">2</div>
        <div id="user2" class="username" data-num="2"
          style="background-image: url(svg/user.svg);background-size: cover;">阿文
        </div>
        <div class="flexbox statusbox">
          <div data-num="2" class="status ax2" style="
                background-image: url(svg/status/status_ax.svg);
                background-size: cover;
              "></div>
          <div data-num="2" class="status car2" style="
                background-image: url(svg/status/status_car.svg);
                background-size: cover;
              "></div>
          <div data-num="2" class="status lamp2" style="
                background-image: url(svg/status/status_lamp.svg);
                background-size: cover;
              "></div>
        </div>
      </div>




    </div>
    <!-- 棋盤格子區 -->
    <div class="flexbox showarea">
      <div class="line line1">
        <div id="block1-1" class="block block1-1"></div>
        <div id="block1-2" class="block block1-2"></div>
        <div id="block1-3 end2" class="block block1-3 end2">
          <img src="svg/card_start.svg" alt="" />
        </div>
        <div id="block1-4" class="block block1-4"></div>
        <div id="block1-5" class="block block1-5 end3"></div>
      </div>
      <div class="line line2">
        <div id="block2-1" class="block block2-1"></div>
        <div id="block2-2" class="block block2-2"></div>
        <div id="block2-3" class="block block2-3"></div>
        <div id="block2-4" class="block block2-4"></div>
        <div id="block2-5" class="block block2-5"></div>
      </div>
      <div class="line line3">
        <div id="block3-1" class="block block3-1"></div>
        <div id="block3-2" class="block block3-1"></div>
        <div id="block3-3" class="block block3-1"></div>
        <div id="block3-4" class="block block3-1"></div>
        <div id="block3-5" class="block block3-1"></div>
      </div>
      <div class="line line4">
        <div id="block4-1" class="block block4-1"></div>
        <div id="block4-2" class="block block4-1"></div>
        <div id="block4-3" class="block block4-1"></div>
        <div id="block4-4" class="block block4-1"></div>
        <div id="block4-5" class="block block4-1"></div>
      </div>
      <div class="line line5">
        <div id="block5-1" class="block block5-1"></div>
        <div id="block5-2" class="block block5-1"></div>
        <div id="block5-3" class="block block5-1"></div>
        <div id="block5-4" class="block block5-1"></div>
        <div id="block5-5" class="block block5-1"></div>
      </div>
      <div class="line line6">
        <div id="block6-1" class="block block6-1"></div>
        <div id="block6-2" class="block block6-1"></div>
        <div id="block6-3" class="block block6-1"></div>
        <div id="block6-4" class="block block6-1"></div>
        <div id="block6-5" class="block block6-1"></div>
      </div>
      <div class="line line7">
        <div id="block7-1" class="block block7-1"></div>
        <div id="block7-2" class="block block7-1"></div>
        <div id="block7-3" class="block block7-1"></div>
        <div id="block7-4" class="block block7-1"></div>
        <div id="block7-5" class="block block7-1"></div>
      </div>
      <div class="line line8">
        <div id="block8-1" class="block block8-1"></div>
        <div id="block8-2" class="block block8-1"></div>
        <div id="block8-3" class="block block8-1"></div>
        <div id="block8-4" class="block block8-1"></div>
        <div id="block8-5" class="block block8-1"></div>
      </div>
      <div class="line line9">
        <div id="block9-1 end1" class="block block9-1 end1">
          <img data-num="0" src="svg/cards_blank.svg" alt="" id="end1" />
        </div>
        <div id="block9-2" class="block block9-2"></div>
        <div id="block9-3 end2" class="block block9-3 end2">
          <img data-num="1" src="svg/cards_blank.svg" alt="" id="end2" />
        </div>
        <div id="block9-4" class="block block9-4"></div>
        <div id="block9-5  end3" class="block block9-5 end3">
          <img data-num="2" src="svg/cards_blank.svg" alt="" id="end3" />
        </div>
      </div>
    </div>

    <!-- 倒數計時器區域 -->
    <div class="round-time-bar" data-style="smooth" style="--duration: 60">
      <div></div>
    </div>
    <div>時間剩下<span id="time">01:00</span>秒！你快出牌喔＾＾</div>
    <!-- 提示區 -->
    <div class="cuetxt">
      請放置卡牌開闢新的路，或是
      <span class="trash"><i id="trash" class="fas fa-trash fa-lg">棄牌並跳過</i></span>
    </div>

    <!-- 手牌區 -->
    <div class="flexbox handcardarea">
      <div class="handcardbox1" data-num="1">
        <img id="handCard1" class="card cardnum1" data-num="1" src="svg/cards_blank.svg" />
        <i data-num="1" class="fas fa-undo-alt cycle-1"></i>
      </div>

      <div class="handcardbox2" data-num="2">
        <img id="handCard2" class="card cardnum2" data-num="2" src="svg/cards_blank.svg" />
        <i data-num="2" class="fas fa-undo-alt cycle-2"></i>
      </div>

      <div class="handcardbox3" data-num="3">
        <img id="handCard3" class="card cardnum3" data-num="3" src="svg/cards_blank.svg" />
        <i data-num="3" class="fas fa-undo-alt cycle-3"></i>
      </div>

      <div class="handcardbox4" data-num="4">
        <img id="handCard4" class="card cardnum4" data-num="4" src="svg/cards_blank.svg" />
        <i data-num="4" class="fas fa-undo-alt cycle-4"></i>
      </div>

      <div class="handcardbox5" data-num="5">
        <img id="handCard5" class="card cardnum5" data-num="5" src="svg/cards_blank.svg" />
        <i data-num="5" class="fas fa-undo-alt cycle-5"></i>
      </div>

      <div class="handcardbox6" data-num="6">
        <img id="handCard6" class="card cardnum6" data-num="6" src="svg/cards_blank.svg" />
        <i data-num="6" class="fas fa-undo-alt cycle-6"></i>
      </div>
    </div>
    <!-- 聊天區 -->
    <hr>
    <ul id="messageBody" class="scrollbox">

    </ul>

    <hr>

    <div class="chaticon"><i class="far fa-comment"></i></div>

    <div class="chatinputbox">
      <div class="chatUser" value="阿婷"></div>
      <input id="inputChat" class="inputChat" type="text" placeholder="來聊天ㄅ">
      <div id="chatbtn" class="chatbtn"></div>
      <div class="chatclose"><i class="fas fa-times"></i></div>
    </div>



  </div>
  <!-- //這是container的div勿刪*/// -->

  <!-- Button trigger modal -->
  <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
    遊戲回合勝負結果
  </button> -->

  <!-- Modal -->
  <!-- <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        <img src="svg/status/goodwin.svg" alt="" class="winpic">
        <div class="modal-header">
          <h5 class="modal-title" id="staticBackdropLabel">好矮人獲勝！</h5>
        </div>
        <div class="modal-body">
          獲勝玩家：
          <div class="username name1">阿婷 <span>5分</span></div>
          <div class="username name2">阿文 <span>5分</span></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="homebtn">回首頁</button>
          <button type="button" class="palyagain">再玩一局</button>
          <button type="button" class="rankbtn">看總排行</button>

        </div>
      </div>
    </div>
  </div> -->

</body>

<script src="./script/api.js"></script>
<script src="./script/common.js"></script>
<script src="https://cdn.socket.io/4.1.2/socket.io.min.js"
  integrity="sha384-toS6mmwu70G0fw54EGlWWeA4z3dyJ+dlXBtSURSKN4vyRFOcxd3Bzjj/AoOwY+Rg" crossorigin="anonymous">
  </script>
<script src="./script/socket.js"></script>
<script src="./script/listener/room.js"></script>

<script>
  var MAP_CARDS = new RegExp('41|42|43|44|45|46', "g");
  var LAMP_CARDS = new RegExp('47|48', "g");
  var AX_CARDS = new RegExp('49|50', "g");
  var CAR_CARDS = new RegExp('51|52', "g");
  var LAMP_BAN_CARDS = new RegExp('56|57|58', "g");
  var AX_BAN_CARDS = new RegExp('59|60|61', "g");
  var CAR_BAN_CARDS = new RegExp('62|63|64', "g");
  var BOMB_CARDS = new RegExp('65|66|67', "g");
  var CURRENT_ROOM_ID = getUrlParameter('room_id');

  const hasRedBorder = () => {
    return $('.redborder').length ? true : false;
  }



  $(".container").click(function (e) {
    console.log(e)

    console.log($('.redborder').attr('class'));
  })

  //遊戲開始時，隨機產生六張手牌給玩家
  var pools = [];

  let poolsGenerator = function (arr) {
    if (arr.length >= 67) return;
    let newNumber = Math.floor(Math.random() * 67 + 1);
    if (arr.indexOf(newNumber) < 0) {
      arr.push(newNumber);
    }
    poolsGenerator(arr);
  };
  poolsGenerator(pools);

  let handCards = [];
  handCards = pools.splice(0, 6)

  function Cardput() {
    //如果點選牌面上已放好的卡（沒有id），且圈選到的是“崩路卡”，警示，『刪掉一張卡』，初新手牌
    if (event.target.id == "" && $('.redborder').attr("src").search(/65|66|67/) == 14) {
      alert("確定要崩掉這張卡ㄇ！？");
      giveNewCard();
      $(".topcue").text("你剛剛炸掉了一張卡牌～")
      return;
      //問題 :還沒做出把圖卡清除的功能??????

    }
    //圈選手牌後，可再點擊的位置：block|end|trash，其他處不可放卡牌，如：起始牌、已放卡牌的位置
    if (event.target.id.search(/block|end|trash/) == -1) {
      alert("此處不能放置卡牌");
      return;
    }
    //如果圈選的手牌是“地圖卡”，不可放在牌區，只可以丟棄，或去點終點卡
    if ($('.redborder').attr("src").search(/41|42|43|44|45|46/) == 14) {
      alert("不能把地圖卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“破壞卡”，不可放在牌區
    if ($('.redborder').attr("src").search(/56|57|58|59|60|61|62|63|64/) == 14) {
      alert("不能把破壞卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“崩路卡”，不可放在牌區，只可以丟棄，或去點已放的卡牌炸掉
    if ($('.redborder').attr("src").search(/65|66|67/) == 14) {
      alert("不能把崩路卡放在這邊喔！");
      return;
    }
    //如果圈選的手牌是“道路卡”，可以放在牌區，並且會印出出牌的卡，並在補上手牌
    if (event.target.id.search("block") == 0) {
      printNewCard()
      giveNewCard();
    }
  }

  function printNewCard() {
    const element = document.getElementById(event.target.id);
    const boxnum = $(".redborder").attr("data-num")
    const svg = $(".handcardbox" + boxnum + " img").attr('src');
    const style = $(".handcardbox" + boxnum + " img").css('transform');
    element.innerHTML += `<img src='${svg}' style='transform:${style}'>`;
  }

  function giveNewCard() {
    const boxnum = $(".redborder").attr("data-num")
    const index = boxnum - 1
    handCards.splice(index, 1, pools.pop());
    $(`#handCard${boxnum}`).attr("src", `svg/cards/card${handCards[index]}.svg`)
    $(".redborder").removeClass("redborder");
  }

  $(document).ready(function () {
    $("#handCard1").attr("src", `svg/cards/card${handCards[0]}.svg`);
    $("#handCard2").attr("src", `svg/cards/card${handCards[1]}.svg`);
    $("#handCard3").attr("src", `svg/cards/card${handCards[2]}.svg`);
    $("#handCard4").attr("src", `svg/cards/card${handCards[3]}.svg`);
    $("#handCard5").attr("src", `svg/cards/card${handCards[4]}.svg`);
    $("#handCard6").attr("src", `svg/cards/card${handCards[5]}.svg`);

    sendEvent('join', {
      roomId: CURRENT_ROOM_ID,
      nickname: getNickName()
    })
  });

  $(".block").click(function (e) {
    if (!hasRedBorder()) {
      return;
    }
    if (hasRedBorder()) {
      Cardput();
    }
  })

  // 圖卡旋轉
  var degrees = 0;

  function rotatecard(object) {
    degrees += 180;
    console.log(degrees)
    object.css({
      'transform': 'rotate(' + degrees + 'deg)',
      '-ms-transform': 'rotate(' + degrees + 'deg)',
      '-moz-transform': 'rotate(' + degrees + 'deg)',
      '-webkit-transform': 'rotate(' + degrees + 'deg)',
      '-o-transform': 'rotate(' + degrees + 'deg)'
    });
  }

  var degrees = 0;
  $(".fa-undo-alt").on("click", function (e) {
    const number = $(this).attr("data-num")
    rotatecard($(".cardnum" + number));
  });


  //功能:點擊卡牌產生紅色提醒
  $(".card").click(function (e) {
    // console.log($(this).attr('class').search("redborder")); 找不到會回傳-1
    if ($(this).attr('class').search("redborder") == -1) {
      $(".redborder").removeClass("redborder");
      $(this).addClass("redborder");

    }
  });


  // 功能：棄牌並跳過
  $(".trash").click(function (event) {
    if (!hasRedBorder()) {
      return;
    }
    alert("確定要丟掉這張牌ㄇ！？好像按了也只能丟了＾＾");
    giveNewCard();
    $(".topcue").text("你剛剛棄掉了一張卡牌～")
  })
  //山崩卡


  //隨機產生三張終點卡、終點卡只供有地圖卡的人查看//
  let endCards = [];

  let endCardsGenerator = function (arr) {
    if (arr.length >= 3) return;
    let newNumber = Math.floor(Math.random() * 3 + 1);
    if (arr.indexOf(newNumber) < 0) {
      arr.push(newNumber);
    }
    endCardsGenerator(arr);
  };
  endCardsGenerator(endCards);

  $("#end1").click(function () {
    if (!hasRedBorder()) {
      rotatecard($(this));
      return;
    }
    if ($('.redborder').attr("src").search(MAP_CARDS) == -1) {
      alert("你這張不是地圖卡，要有地圖卡才能看！");
      return;
    }
    if ($('.redborder').attr("src").search(/41|42|43|44|45|46/) !== -1) {
      giveNewCard();
      $(".topcue").text("你查看了一張終點卡")
      $(this).attr("src", `svg/card_end${endCards[0]}.svg`);

      return;
      alert("一張地圖卡只能看一次喔！"); //這個還沒做出來

    }
  });


  //提示TopCue
  $(".handcardarea").click(function () {
    $(".topcue").text("可從手牌區選擇一張卡出牌！");
    if ($('.redborder').attr("src").search(/41|42|43|44|45|46/) !== -1) {
      $(".topcue").text("使用地圖卡可以查看一張終點卡！");
    }
    if ($('.redborder').attr("src").search(/65|66|67/) !== -1) {
      $(".topcue").text("使用山崩卡可以炸毀一條路！");
    }
  });

  // 封鎖時顯示上方提示//
  $(".username").mouseenter(function (e) {
    $(".topcue").text(`來啊！來破壞${$(e.target).text()}的工具！`);
  });
  $(".username").mouseleave(function (e) {
    $(".topcue").text("輪到你出牌囉")
  });

  //封鎖
  $(".username").click(function (e) {
    const LAMP_BAN = $('.redborder').attr("src").search(LAMP_BAN_CARDS)
    const AX_BAN = $('.redborder').attr("src").search(AX_BAN_CARDS)
    const CAR_BAN = $('.redborder').attr("src").search(CAR_BAN_CARDS)

    const LAMP_SAVE = $('.redborder').attr("src").search(LAMP_CARDS)
    const AX_SAVE = $('.redborder').attr("src").search(AX_CARDS)
    const CAR_SAVE = $('.redborder').attr("src").search(CAR_CARDS)

    let hasBanTool = false;
    let toolName = '';
    let toolChineseName = '';
    if (LAMP_BAN !== -1) {
      hasBanTool = true;
      toolName = "lamp"
      toolChineseName = "燈"
    }
    if (AX_BAN !== -1) {
      hasBanTool = true;
      toolName = "ax"
      toolChineseName = "斧頭"
    }
    if (CAR_BAN !== -1) {
      hasBanTool = true;
      toolName = "car"
      toolChineseName = "礦車"
    }

    let hasSaveTool = false;
    let savetoolName = '';
    let savetoolChineseName = '';
    if (LAMP_SAVE !== -1) {
      hasSaveTool = true;
      savetoolName = "lamp"
      savetoolChineseName = "燈"
    }
    if (AX_SAVE !== -1) {
      hasSaveTool = true;
      savetoolName = "ax"
      savetoolChineseName = "斧頭"
    }
    if (CAR_SAVE !== -1) {
      hasSaveTool = true;
      savetoolName = "car"
      savetoolChineseName = "礦車"
    }

    if (!hasRedBorder()) {
      return;
    }
    if (!hasBanTool && !hasSaveTool) {
      alert("你這張不是破壞卡或修理卡，不能用在這邊！");
      return;
    }

    if (LAMP_BAN !== -1 || AX_BAN !== -1 || CAR_BAN !== -1) {
      const usernum = $(`#${e.target.id}`).attr("data-num");
      $(`.${toolName}${usernum}`).addClass("statusBan");
      $(".topcue").text(`${$(e.target).text()}的${toolChineseName}被你破壞了！`);
      giveNewCard();
    }
    // if (LAMP_SAVE !== -1 || AX_SAVE !== -1 || CAR_SAVE !== -1 && $(`.${toolName}${usernum}`).attr("class").search(
    //     "statusBan") == -1) {
    //   return;
    //   alert("這位玩家沒有工具被破壞，所以你不能用修理卡在他身上")
    //   // const checkToolBan = $(`.${toolName}${usernum}`).attr("class").search("statusBan")
    // }
    if (LAMP_SAVE !== -1 || AX_SAVE !== -1 || CAR_SAVE !== -1) {
      const usernum = $(`#${e.target.id}`).attr("data-num");
      $(`.${savetoolName}${usernum}`).removeClass("statusBan");
      $(".topcue").text(`${$(e.target).text()}的${savetoolChineseName}被你修理好了～`);
      giveNewCard();
    }

  })

  const scrollbox = document.querySelector('.scrollbox');
  var messageBody = document.querySelector('#messageBody');
  messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;

  // 聊天室新增 聊天內容
  const inputChat = document.querySelector(".inputChat");
  const chatbtn = document.querySelector(".chatbtn");

  $(".chatbtn").click(function (e) {
    const chatUser = getNickName();

    const inputChatcontent = $('.inputChat').val();
    if (inputChatcontent.trim() === '') {
      return;
    }

    sendEvent('sendMessage', {
      roomId: CURRENT_ROOM_ID,
      nickname: chatUser,
      content: inputChatcontent,
    });

    $('.inputChat').val('');
    
    messageBody.scrollTop = messageBody.scrollHeight - messageBody.clientHeight;
  })

  function renderChatRecord(chatRecord) {
    const chatUser = chatRecord.nickname;
    const content = chatRecord.content;

    $('#messageBody').append(`
      <li>${chatUser}：${content}</li >
    `);
  }

  inputChat.addEventListener("keyup", function (event) {
    if (event.keyCode === 13) {
      event.preventDefault();
      document.getElementById("chatbtn").click();
    }
  });

  $(".chatclose").click(function () {
    $(".chatinputbox").hide();
  })
  $(".chaticon").click(function () {
    $(".chatinputbox").show();
  })


  //點選連結到別的畫面
  $('.homebtn').click(function () {
    window.location.href = "./index.html";
  });
  $('.palyagain').click(function () {
    window.location.href = "./waiting.html";
  });
  $('.rankbtn').click(function () {
    window.location.href = "./rank.html";
  })

  // 倒數計時器
  function startTimer(duration, display) {
    var timer = duration,
      minutes, seconds;
    setInterval(function () {
      minutes = parseInt(timer / 60, 10);
      seconds = parseInt(timer % 60, 10);
      minutes = minutes < 10 ? "0" + minutes : minutes;
      seconds = seconds < 10 ? "0" + seconds : seconds;
      display.textContent = minutes + ":" + seconds;
      if (--timer < 0) {
        timer = duration;
      }
    }, 1000);
  }
  window.onload = function () {
    var fiveMinutes = 60 * 1,
      display = document.querySelector('#time');
    startTimer(fiveMinutes, display);
  }; //倒數計時器顯示圖
  const bars = document.querySelectorAll(".round-time-bar");
  bars.forEach((bar) => {
    bar.classList.remove("round-time-bar");
    bar.offsetWidth;
    bar.classList.add("round-time-bar");
  });
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/css/bootstrap.min.css" rel="stylesheet" //
  integrity="sha384-wEmeIV1mKuiNpC+IOBjI7aAzPcEZeedi5yW5f2yOq55WWLwNGmvvx4Um1vskeMj0" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"
  integrity="sha384-p34f1UUtsS3wqzfto5wAAmdvj+osOnFyQFpp4Ua3gs/ZVWx6oOypYoCJhGGScy+8" crossorigin="anonymous">
</script>

</html>
